{{ $pageId := . }}
<script defer>
/**
 * =================
 * Initialize all Action Menu features
 * - comment toggle
 * - comment count
 * - like
 * =================
 */

/**
 * =================
 * Toggle Comment Section
 * =================
 */

function initializeComments() {
  const commentsToggle = document.getElementById('comments-toggle');
  const commentsSection = document.getElementById('comments-section');

  if (!commentsToggle || !commentsSection) return;

  // click on toggle
  commentsToggle.addEventListener('click', function() {
    const isHidden = commentsSection.classList.contains('hidden');
    const entranceAnimation = 'animate-slide-in-down';
    const exitAnimation = 'animate-slide-out-up';

    if (isHidden) {
      // switch on
      commentsSection.classList.remove('hidden', exitAnimation);
      commentsSection.classList.add(entranceAnimation);
    } else {
      // switch off
      commentsSection.classList.remove(entranceAnimation);
      commentsSection.classList.add(exitAnimation);
      setTimeout(() => {
        commentsSection.classList.add('hidden');
      }, 200);
    }
  });
}

/**
 * =================
 * Fetch and set Comment Count
 * =================
 */

function initializeCommentCount() {
  const commentCountEl = document.getElementById('comment-count');
  if (!commentCountEl) return;

  // è®¾ç½®åˆå§‹å€¼
  commentCountEl.textContent = '0';

  // ç›‘å¬ Giscus çš„æ¶ˆæ¯äº‹ä»¶
  window.addEventListener('message', function(event) {
    if (event.origin !== 'https://giscus.app') return;

    const giscusData = event.data;

    // æ£€æŸ¥æ˜¯å¦ä¸º IMetadataMessage - æ•°æ®ç»“æ„æ˜¯ {giscus: {discussion: {...}}}
    if (giscusData.giscus && giscusData.giscus.discussion) {
      const discussion = giscusData.giscus.discussion;

      // è®¡ç®—æ€»è¯„è®ºæ•°ï¼šä¸»è¯„è®ºæ•° + å›å¤æ•°
      const totalComments = (discussion.totalCommentCount || 0) + (discussion.totalReplyCount || 0);
      commentCountEl.textContent = totalComments.toString();
    }
  });
}

/**
 * =================
 * Initialize like functionality
 * =================
 */

function initializeLikes(pageId) {
  const elements = {
    count: document.getElementById("like-count-" + pageId),
    btn: document.getElementById("like-btn-" + pageId),
    container: document.getElementById("like-container-" + pageId),
    icon: document.getElementById("like-icon-" + pageId)
  };

  if (!elements.count || !elements.btn || !elements.container) return;

  function updateTooltip() {
    if (elements.container.classList.contains('liked')) {
      elements.btn.setAttribute('title', elements.btn.getAttribute('data-liked-title'));
    } else {
      elements.btn.setAttribute('title', 'ä¸ºè¿™ç¯‡æ–‡ç« çŒ®ä¸Šå¿ƒè„');
    }
  }

  function setLikedState() {
    if (elements.icon) {
      elements.icon.classList.add('liked-heart', 'heartbeat');
    }
    if (elements.count) {
      elements.count.classList.add('liked-count');
    }
    elements.btn.disabled = true;
    elements.container.classList.add('liked');
    updateTooltip();
  }

  async function fetchLikes() {
    try {
      const response = await fetch("https://like.guhub.cn/like/" + pageId);
      const data = await response.json();
      elements.count.innerText = data.likes ?? 0;
      if (localStorage.getItem("liked_" + pageId)) {
        setLikedState();
      }
    } catch(e) {
      console.log('Failed to fetch likes:', e);
      elements.count.innerText = "âŒ";
    }
  }

  window.sendLike = async function(pageId) {
    if (localStorage.getItem("liked_" + pageId)) return;

    if (window.location.hostname !== 'localhost' && typeof umami !== 'undefined') {
      umami.track('ğŸ‘ Hit Like Button');
    }

    try {
      const response = await fetch("https://like.guhub.cn/like/" + pageId, { method: "POST" });
      const data = await response.json();
      localStorage.setItem("liked_" + pageId, "1");
      elements.count.innerText = data.likes ?? 1;
      setLikedState();
    } catch(e) {
      console.log('Failed to send like:', e);
      alert("ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
    }
  };

  // åˆå§‹åŒ–è·å–ç‚¹èµæ•°
  fetchLikes();
}

/**
 * =================
 * Load features after DOMContentLoaded
 * =================
 */

function initializeFeatures() {
  const pageId = "{{ $pageId }}";
  if (!pageId) return;

  initializeComments();
  initializeLikes(pageId);
  initializeCommentCount();
}

document.addEventListener('DOMContentLoaded', initializeFeatures);
</script>
