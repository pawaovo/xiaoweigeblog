{{ $pageId := . }}
<script defer>
/**
 * =================
 * Initialize all Action Menu features
 * - comment toggle
 * - comment count
 * - like
 * =================
 */

/**
 * =================
 * Toggle Comment Section
 * =================
 */

function initializeComments() {
  const commentsToggle = document.getElementById('comments-toggle');
  const commentsSection = document.getElementById('comments-section');

  if (!commentsToggle || !commentsSection) return;

  // åŠ¨ç”»é…ç½®å¸¸é‡
  const ENTRANCE_ANIMATION = 'animate-slide-in-down';
  const EXIT_ANIMATION = 'animate-slide-out-up';
  const ANIMATION_DURATION = 200;

  // click on toggle
  commentsToggle.addEventListener('click', function() {
    const isHidden = commentsSection.classList.contains('hidden');

    if (isHidden) {
      // switch on
      commentsSection.classList.remove('hidden', EXIT_ANIMATION);
      commentsSection.classList.add(ENTRANCE_ANIMATION);
    } else {
      // switch off
      commentsSection.classList.remove(ENTRANCE_ANIMATION);
      commentsSection.classList.add(EXIT_ANIMATION);
      setTimeout(() => {
        commentsSection.classList.add('hidden');
      }, ANIMATION_DURATION);
    }
  });
}

/**
 * =================
 * Fetch and set Comment Count
 * =================
 */

function initializeCommentCount() {
  const commentCountEl = document.getElementById('comment-count');
  if (!commentCountEl) return;

  const observer = new MutationObserver(() => {
    // check if giscus is loaded
    const giscusIframe = document.querySelector('iframe.giscus-frame');
    if (!giscusIframe) return;

    giscusIframe.addEventListener('load', () => {
      // receive message from giscus iframe
      window.addEventListener('message', function(event) {
        if (event.origin !== 'https://giscus.app') return;
        const giscusData = event.data;
        if (giscusData.giscus?.discussion) {
          const discussion = giscusData.giscus.discussion;
          const totalComments = (discussion.totalCommentCount || 0) + (discussion.totalReplyCount || 0);
          // set comment count
          commentCountEl.textContent = totalComments.toString();
        // if no discussion found, set to 0
        } else commentCountEl.textContent = '0';
      });
    });

    observer.disconnect();
  });
  observer.observe(document.body, { childList: true, subtree: true });
}

/**
 * =================
 * Initialize like functionality
 * =================
 */

function initializeLikes(pageId) {
  // æ£€æŸ¥æ˜¯å¦åœ¨ç”Ÿäº§çŽ¯å¢ƒ
  const isProduction = window.location.hostname.includes('xiaoweigezzz.xyz');

  const elements = {
    count: document.getElementById("like-count-" + pageId),
    btn: document.getElementById("like-btn-" + pageId),
    container: document.getElementById("like-container-" + pageId),
    icon: document.getElementById("like-icon-" + pageId)
  };

  if (!elements.count || !elements.btn || !elements.container) return;

  function setLikedState() {
    // update classes
    elements.icon?.classList.add('liked-heart');
    elements.icon?.classList.add('heartbeat');
    elements.count?.classList.add('liked-count');
    elements.btn.disabled = true;
    elements.container.classList.add('liked');
    // update tooltip
    elements.btn.setAttribute('title',
      elements.container.classList.contains('liked')
        ? elements.btn.getAttribute('data-liked-title')
        : 'ä¸ºè¿™ç¯‡æ–‡ç« çŒ®ä¸Šå¿ƒè„'
    );
  }

  async function fetchLikes() {
    try {
      // åªåœ¨ç”Ÿäº§çŽ¯å¢ƒå°è¯•èŽ·å–çœŸå®žç‚¹èµžæ•°
      if (isProduction) {
        const response = await fetch("https://like.guhub.cn/like/" + pageId);
        const data = await response.json();
        elements.count.innerText = data.likes ?? 0;
      } else {
        // æœ¬åœ°çŽ¯å¢ƒæ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
        const mockLikes = Math.floor(Math.random() * 20) + 1;
        elements.count.innerText = mockLikes;
        console.log('æœ¬åœ°çŽ¯å¢ƒï¼šæ˜¾ç¤ºæ¨¡æ‹Ÿç‚¹èµžæ•°', mockLikes);
      }

      if (localStorage.getItem("liked_" + pageId)) {
        setLikedState();
      }
    } catch(e) {
      console.log('èŽ·å–ç‚¹èµžæ•°å¤±è´¥:', e);
      // æ˜¾ç¤ºé»˜è®¤å€¼è€Œä¸æ˜¯é”™è¯¯æ ‡è®°
      elements.count.innerText = "0";
    }
  }

  // æœ¬åœ°çŽ¯å¢ƒç‚¹èµžå¤„ç†å‡½æ•°
  function handleLocalLike() {
    localStorage.setItem("liked_" + pageId, "1");
    const currentCount = parseInt(elements.count.innerText) || 0;
    elements.count.innerText = currentCount + 1;
    setLikedState();
    console.log('æœ¬åœ°çŽ¯å¢ƒï¼šæ¨¡æ‹Ÿç‚¹èµžæˆåŠŸ');
  }

  window.sendLike = async function(pageId) {
    if (localStorage.getItem("liked_" + pageId)) return;

    if (window.location.hostname !== 'localhost' && typeof umami !== 'undefined') {
      umami.track('ðŸ‘ Hit Like Button');
    }

    try {
      if (isProduction) {
        // ç”Ÿäº§çŽ¯å¢ƒï¼šå°è¯•çœŸå®žAPI
        const response = await fetch("https://like.guhub.cn/like/" + pageId, { method: "POST" });
        const data = await response.json();
        localStorage.setItem("liked_" + pageId, "1");
        elements.count.innerText = data.likes ?? 1;
        setLikedState();
      } else {
        // æœ¬åœ°çŽ¯å¢ƒï¼šæ¨¡æ‹Ÿç‚¹èµžæˆåŠŸ
        handleLocalLike();
      }
    } catch(e) {
      console.log('ç‚¹èµžå¤±è´¥:', e);
      if (isProduction) {
        alert("ç‚¹èµžåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åŽå†è¯•");
      } else {
        // æœ¬åœ°çŽ¯å¢ƒå³ä½¿APIå¤±è´¥ä¹Ÿå…è®¸æ¨¡æ‹Ÿç‚¹èµž
        handleLocalLike();
      }
    }
  };

  // fetch likes when action menu is visible
  const actionMenu = document.getElementById("action-menu");
  if (actionMenu) {
    const observer = new IntersectionObserver((entries, obs) => {
      if (entries[0].isIntersecting) {
        fetchLikes();
        obs.disconnect();
      }
    });
    observer.observe(actionMenu);
  } else {
    // fallback: fetch immediately if action menu not found
    fetchLikes();
  }
}

/**
 * =================
 * Load features after DOMContentLoaded
 * =================
 */

function initializeFeatures() {
  const pageId = "{{ $pageId }}";
  if (!pageId) return;

  initializeComments();
  initializeLikes(pageId);
  initializeCommentCount();
}

document.addEventListener('DOMContentLoaded', initializeFeatures);
</script>
