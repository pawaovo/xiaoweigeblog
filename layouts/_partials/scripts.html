<!-- third-party libraries -->
{{- range .Site.Params.externalJSFiles }}
  <script src="{{ $.Site.Params.staticPrefix }}{{ . | relURL }}"></script>
{{- end }}

{{- if or (in .Section "posts") (in .Section "cards") (in .Section "library") (eq .Type "single") }}
  <script src="/js/fancybox.umd.js"></script>
  <script>Fancybox.bind("[data-fancybox]");</script>
{{- end }}

{{ if .Params.aplayer }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const lazyPlayers = document.querySelectorAll(".lazy-aplayer");
  if (!lazyPlayers.length) return;

  const loadAPlayer = () => {
    if (window.APlayer) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = "https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js";
      script.onload = resolve;
      script.onerror = reject;
      document.body.appendChild(script);
    });
  };

  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        loadAPlayer().then(() => {
          const el = entry.target;
          const id = el.dataset.id ? `-` + el.dataset.id : ``;
          const container = document.createElement('div');
          container.id = `aplayer${id}`;
          el.appendChild(container);

          const ap = new APlayer({
            container: container,
            audio: [{
              name: el.dataset.name,
              artist: el.dataset.artist,
              url: el.dataset.url,
              cover: el.dataset.cover
            }]
          });

          ap.on('play', () => umami?.track?.('ðŸŽµ Play music with aPlayer'));
          ap.on('ended', () => umami?.track?.('ðŸŽµ Played entiresong with aPlayer'));

          obs.unobserve(el);
        });
      }
    });
  });

  lazyPlayers.forEach(player => observer.observe(player));
});
</script>
{{ end }}

<script>
  littlefoot.littlefoot({
    dismissOnUnhover: true,
    activateOnHover: true
  });
</script>
