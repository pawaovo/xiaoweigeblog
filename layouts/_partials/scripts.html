<!-- third-party libraries -->
{{- range .Site.Params.externalJSFiles }}
  <script src="{{ $.Site.Params.staticPrefix }}{{ . | relURL }}"></script>
{{- end }}

{{- if or (in .Section "posts") (in .Section "cards") (in .Section "library") (in .Section "demos") (eq .Type "single") }}
<script type="module">
  import LightBox from '/js/libra.min.js';
  const lightbox = new LightBox({ offset: { x: -8 ,y: -80 } });
</script>
{{- end }}

{{ with resources.Get "js/tooltip.js" }}
<script>{{ .Content | safeJS }}</script>
{{ end }}

{{ with resources.Get "js/settings.js" }}
<script>{{ .Content | safeJS }}</script>
{{ end }}

{{ with resources.Get "js/toc.js" }}
<script>{{ .Content | safeJS }}</script>
{{ end }}

{{ if .Params.aplayer }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const lazyPlayers = document.querySelectorAll(".lazy-aplayer");
  if (!lazyPlayers.length) return;

  const loadAPlayer = () => {
    if (window.APlayer) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = "https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js";
      script.onload = resolve;
      script.onerror = reject;
      document.body.appendChild(script);
    });
  };

  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        loadAPlayer().then(() => {
          const el = entry.target;
          const id = el.dataset.id ? `-` + el.dataset.id : ``;
          const container = document.createElement('div');
          container.id = `aplayer${id}`;
          el.appendChild(container);

          const ap = new APlayer({
            container: container,
            audio: [{
              name: el.dataset.name,
              artist: el.dataset.artist,
              url: el.dataset.url,
              cover: el.dataset.cover
            }]
          });

          ap.on('play', () => umami?.track?.('ðŸŽµ Play music with aPlayer'));
          ap.on('ended', () => umami?.track?.('ðŸŽµ Played entiresong with aPlayer'));

          obs.unobserve(el);
        });
      }
    });
  });

  lazyPlayers.forEach(player => observer.observe(player));
});
</script>
{{ end }}

{{ partial "scripts/littlefoot-js" . }}

<!-- ç§å¯†æ–‡ç« åŠŸèƒ½ - åªåœ¨éœ€è¦çš„é¡µé¢åŠ è½½ -->
{{- if or (in .Section "posts") (in .Section "cards") (in .Section "library") (eq .Type "single") (eq .Kind "home") }}
<script src="/js/private-posts.js"></script>
{{- end }}
